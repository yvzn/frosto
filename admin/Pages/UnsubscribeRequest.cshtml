@page
@model admin.Pages.UnsubscribeRequestModel
@{
	ViewData["Title"] = "Unsubscribe by link";
	var hasEmail = !string.IsNullOrWhiteSpace(Model.CurrentRequest?.email);
	var hasLocid = !string.IsNullOrWhiteSpace(Model.CurrentRequest?.locid);
	var hasEmailScenario = hasEmail;
}

<div class="text-center">
	<h1 class="display-4">Unsubscribe by link</h1>
</div>

@if (Model.IsProcessing)
{
	<div class="row mb-5">
		<div class="col-12">
			@if (hasEmailScenario)
			{
				<h2>Request Details</h2>
				<div class="table-responsive">
					<table class="table table-bordered">
						<thead>
							<tr>
								<th>Property</th>
								<th>Value</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td><strong>Email</strong></td>
								<td>@Model.CurrentRequest?.email</td>
							</tr>
							@if (hasLocid)
							{
								<tr>
									<td><strong>Location Id</strong></td>
									<td>@Model.CurrentRequest?.locid</td>
								</tr>
							}
						</tbody>
					</table>
				</div>

				@if (hasLocid)
				{
					<a asp-page="./UnsubscribeEmail" asp-route-q='@Model.CurrentRequest?.email'
						asp-route-id='@Model.CurrentRequest?.locid' target="_blank" class="btn btn-success mt-3">Proceed to
						Unsubscribe</a>
				}
				else
				{
					<a asp-page="./UnsubscribeEmail" asp-route-q='@Model.CurrentRequest?.email'
						target="_blank" class="btn btn-success mt-3">Proceed to Unsubscribe</a>
				}
			}
			else
			{
				<h2>Token Validation Results</h2>

				@if (!string.IsNullOrEmpty(Model.ErrorMessage))
				{
					<div class="alert alert-danger" role="alert">
						@Model.ErrorMessage
					</div>
				}
				else
				{
					<div class="table-responsive">
						<table class="table table-bordered">
							<thead>
								<tr>
									<th>Property</th>
									<th>Value</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td><strong>Signature Verification</strong></td>
									<td>
										@if (Model.SignatureValid)
										{
											<span class="badge bg-success">Valid</span>
										}
										else
										{
											<span class="badge bg-danger">Invalid</span>
										}
									</td>
								</tr>
								<tr>
									<td><strong>Algorithm</strong></td>
									<td>@Model.Algorithm</td>
								</tr>
								@foreach (var claim in Model.TokenClaims)
								{
									<tr>
										<td><strong>@claim.Key</strong></td>
										<td>@claim.Value</td>
									</tr>
								}
							</tbody>
						</table>
					</div>
				}

				@if (string.IsNullOrEmpty(Model.ErrorMessage) && Model.SignatureValid)
				{
					<a asp-page="./UnsubscribeEmail" asp-route-q='@Model.TokenClaims["sub"]'
						asp-route-id='@Model.TokenClaims["sub_id"]' target="_blank" class="btn btn-success mt-3">Proceed to
						Unsubscribe</a>
				}
			}

			<a asp-page="./UnsubscribeRequest" class="btn btn-outline-secondary mt-3">Back to List</a>
		</div>
	</div>
}

@if (Model.ShowDeletionSummary && Model.DeletedRequest != null)
{
	<div class="row mb-5">
		<div class="col-12">
			<div class="alert alert-success" role="alert">
				<h4 class="alert-heading">Request Deleted Successfully</h4>
				<p>The unsubscribe request has been marked as complete and removed from the queue.</p>
			</div>

			<div class="card">
				<div class="card-header">
					<strong>Deleted Request Details</strong>
				</div>
				<div class="card-body">
					<table class="table table-bordered">
						<tbody>
							<tr>
								<td><strong>Token</strong></td>
								<td>
									<span class="text-truncate d-inline-block" style="max-width: 600px;"
										title="@Model.DeletedRequest.user">
										@Model.DeletedRequest.user
									</span>
								</td>
							</tr>
							<tr>
								<td><strong>Language</strong></td>
								<td>@Model.DeletedRequest.lang</td>
							</tr>
							<tr>
								<td><strong>Last Modified</strong></td>
								<td>@Model.DeletedRequest.Timestamp</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>

			<div class="mt-3">
				<a asp-page="./UnsubscribeRequest" class="btn btn-primary">Back to List</a>
			</div>
		</div>
	</div>
}

@if (!Model.IsProcessing && !Model.ShowDeletionSummary)
{
	<div class="row mb-5">
		@if (Model.UnsubscribeRequests.Count == 0)
		{
			<p class="text-muted">No unsubscribe requests pending.</p>
		}
		else
		{
			<div class="table-responsive">
				<table class="table">
					<caption>@Model.UnsubscribeRequests.Count items</caption>
					<thead>
						<tr>
							<th>Token</th>
							<th>Email</th>
							<th>Language</th>
							<th>Last Modified</th>
							<th></th>
						</tr>
					</thead>
					<tbody>
						@foreach (var request in Model.UnsubscribeRequests)
						{
							<tr>
								<td>
									<span class="text-truncate d-inline-block" style="max-width: 300px;" title="@request.user">
										@request.user
									</span>
								</td>
								<td>@Html.DisplayFor(modelItem => request.email)</td>
								<td>@Html.DisplayFor(modelItem => request.lang)</td>
								<td>@Html.DisplayFor(modelItem => request.Timestamp)</td>
								<td><a asp-page-handler="Process" asp-route-id="@request.Id">Process</a></td>
							</tr>
						}
					</tbody>
				</table>
			</div>
		}
	</div>
}

@if (Model.IsProcessing && Model.CurrentRequest != null && !string.IsNullOrEmpty(Model.CurrentRequest.Id))
{
	<div class="row">
		<form method="post" class="col-lg-8 p-5 my-5 border rounded-3 border-danger bg-danger-subtle">
			<h2 class="text-danger mb-3">Danger Zone</h2>

			<details>
				<summary>Mark request as completed</summary>
				<input type="hidden" name="CurrentRequest.Id" value="@Model.CurrentRequest.Id" />
				<button type="submit" class="btn btn-danger mt-3" asp-page-handler="Complete">Complete &amp;
					discard</button>
			</details>
		</form>
	</div>
}

<div hidden>
	@Html.ValidationSummary()
</div>
